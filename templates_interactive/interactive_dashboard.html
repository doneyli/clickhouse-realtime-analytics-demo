<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClickHouse Real-Time Analytics - Live Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            color: rgba(255,255,255,0.9);
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.2em;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            background: #10b981;
            color: white;
            border-radius: 20px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .metric-card h3 {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.85em;
            color: #888;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .panel h2 {
            margin-bottom: 20px;
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .event-stream {
            height: 400px;
            overflow-y: auto;
            font-size: 0.85em;
        }

        .event-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .event-item.purchase {
            border-left-color: #10b981;
            background: #ecfdf5;
        }

        .event-item.page_view {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }

        .event-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 8px;
        }

        .event-type.purchase {
            background: #10b981;
            color: white;
        }

        .event-type.page_view {
            background: #3b82f6;
            color: white;
        }

        .event-type.add_to_cart {
            background: #f59e0b;
            color: white;
        }

        .event-type.click {
            background: #8b5cf6;
            color: white;
        }

        .query-builder {
            margin-bottom: 20px;
        }

        .query-input {
            width: 100%;
            height: 100px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
        }

        .query-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .query-result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .stats-table {
            width: 100%;
            font-size: 0.9em;
        }

        .stats-table td {
            padding: 10px;
        }

        .stats-label {
            font-weight: bold;
            color: #666;
        }

        .chart-container {
            margin: 20px 0;
            height: 300px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }

        .error {
            padding: 15px;
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            border-radius: 4px;
            color: #991b1b;
            margin: 10px 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>‚ö° ClickHouse Real-Time Analytics</h1>
        <p class="subtitle">
            <span class="status-badge">‚óè LIVE</span>
            Updates every second
        </p>

        <!-- Real-time Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <h3>Events/Second</h3>
                <div class="metric-value" id="events-per-sec">0</div>
                <div class="metric-label">Current throughput</div>
            </div>
            <div class="metric-card">
                <h3>Events (5 min)</h3>
                <div class="metric-value" id="events-5min">0</div>
                <div class="metric-label">Last 5 minutes</div>
            </div>
            <div class="metric-card">
                <h3>Active Users</h3>
                <div class="metric-value" id="active-users">0</div>
                <div class="metric-label">Last 5 minutes</div>
            </div>
            <div class="metric-card">
                <h3>Revenue</h3>
                <div class="metric-value" id="revenue">$0</div>
                <div class="metric-label">Last 5 minutes</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Live Event Stream -->
            <div class="panel">
                <h2>üåä Live Event Stream</h2>
                <div id="event-stream" class="event-stream">
                    <div class="loading">Connecting to event stream...</div>
                </div>
            </div>

            <!-- Top Users -->
            <div class="panel">
                <h2>üë• Most Active Users</h2>
                <table class="stats-table" id="top-users-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Events</th>
                            <th>Revenue</th>
                        </tr>
                    </thead>
                    <tbody id="top-users">
                        <tr><td colspan="3" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="content-grid">
            <div class="panel">
                <h2>üìà Event Timeline (30 min)</h2>
                <canvas id="timeline-chart"></canvas>
            </div>
            <div class="panel">
                <h2>üéØ Event Types</h2>
                <canvas id="event-types-chart"></canvas>
            </div>
        </div>

        <!-- Query Builder -->
        <div class="panel">
            <h2>üîç Interactive Query Builder</h2>
            <div class="query-builder">
                <textarea id="query-input" class="query-input" placeholder="SELECT * FROM events WHERE event_timestamp >= now() - INTERVAL 1 MINUTE LIMIT 10">SELECT event_type, count() as count
FROM events
WHERE event_timestamp >= now() - INTERVAL 5 MINUTE
GROUP BY event_type
ORDER BY count DESC</textarea>
                <button class="btn" onclick="executeQuery()">Execute Query</button>
                <div id="query-execution-info" style="margin-top: 10px; color: #666; font-size: 0.9em;"></div>
                <div id="query-result" class="query-result" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Event Stream with Server-Sent Events
        let eventSource = null;
        let eventBuffer = [];
        const MAX_EVENTS = 50;

        function connectEventStream() {
            eventSource = new EventSource('/api/live/events-stream');

            eventSource.onmessage = function(event) {
                try {
                    const events = JSON.parse(event.data);
                    if (events.error) {
                        console.error('Stream error:', events.error);
                        return;
                    }

                    events.forEach(evt => {
                        eventBuffer.unshift(evt);
                    });

                    // Keep only last MAX_EVENTS
                    if (eventBuffer.length > MAX_EVENTS) {
                        eventBuffer = eventBuffer.slice(0, MAX_EVENTS);
                    }

                    updateEventStream();
                } catch (e) {
                    console.error('Parse error:', e);
                }
            };

            eventSource.onerror = function(error) {
                console.error('EventSource error:', error);
                document.getElementById('event-stream').innerHTML = '<div class="error">Connection lost. Reconnecting...</div>';
                eventSource.close();
                setTimeout(connectEventStream, 5000);
            };
        }

        function updateEventStream() {
            const container = document.getElementById('event-stream');
            container.innerHTML = eventBuffer.map(evt => {
                const eventClass = evt.event_type.replace('_', '');
                return `
                    <div class="event-item ${eventClass}">
                        <span class="event-type ${eventClass}">${evt.event_type}</span>
                        <strong>User ${evt.user_id}</strong> |
                        ${evt.country} | ${evt.device_type} | ${evt.browser}
                        ${evt.revenue > 0 ? `<strong style="color: #10b981;">$${evt.revenue.toFixed(2)}</strong>` : ''}
                        <div style="font-size: 0.85em; color: #666; margin-top: 4px;">${evt.event_timestamp}</div>
                    </div>
                `;
            }).join('');
        }

        // Live Metrics Update
        function updateMetrics() {
            fetch('/api/live/metrics')
                .then(r => r.json())
                .then(data => {
                    if (data.events_per_second !== undefined) {
                        document.getElementById('events-per-sec').textContent = data.events_per_second.toFixed(1);
                    }
                    if (data.last_5min) {
                        document.getElementById('events-5min').textContent = data.last_5min.events.toLocaleString();
                        document.getElementById('active-users').textContent = data.last_5min.unique_users.toLocaleString();
                        document.getElementById('revenue').textContent = '$' + data.last_5min.revenue.toFixed(2);
                    }
                })
                .catch(e => console.error('Metrics error:', e));
        }

        // Top Users Update
        function updateTopUsers() {
            fetch('/api/live/top-users')
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('top-users');
                    tbody.innerHTML = data.map(user => `
                        <tr>
                            <td><strong>User ${user.user_id}</strong></td>
                            <td>${user.event_count} events</td>
                            <td style="color: #10b981; font-weight: bold;">$${user.total_revenue.toFixed(2)}</td>
                        </tr>
                    `).join('');
                })
                .catch(e => console.error('Top users error:', e));
        }

        // Timeline Chart
        let timelineChart = null;
        function updateTimelineChart() {
            fetch('/api/live/timeline')
                .then(r => r.json())
                .then(data => {
                    const ctx = document.getElementById('timeline-chart');
                    if (timelineChart) {
                        timelineChart.destroy();
                    }
                    timelineChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.timestamps,
                            datasets: [{
                                label: 'Events',
                                data: data.events,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                })
                .catch(e => console.error('Timeline error:', e));
        }

        // Event Types Chart
        let eventTypesChart = null;
        function updateEventTypesChart() {
            fetch('/api/live/event-types')
                .then(r => r.json())
                .then(data => {
                    const ctx = document.getElementById('event-types-chart');
                    if (eventTypesChart) {
                        eventTypesChart.destroy();
                    }
                    eventTypesChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: data.map(d => d.event_type),
                            datasets: [{
                                data: data.map(d => d.count),
                                backgroundColor: [
                                    '#667eea', '#764ba2', '#f59e0b',
                                    '#10b981', '#3b82f6', '#ef4444',
                                    '#8b5cf6', '#ec4899', '#14b8a6'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                })
                .catch(e => console.error('Event types error:', e));
        }

        // Execute Custom Query
        function executeQuery() {
            const query = document.getElementById('query-input').value;
            const resultDiv = document.getElementById('query-result');
            const infoDiv = document.getElementById('query-execution-info');

            infoDiv.textContent = 'Executing query...';
            resultDiv.style.display = 'none';

            fetch('/api/query/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    resultDiv.innerHTML = `<div class="error">${data.error}</div>`;
                } else {
                    infoDiv.textContent = `‚úÖ Query executed in ${data.execution_time}ms | ${data.row_count} rows returned`;

                    if (data.rows.length > 0) {
                        const table = document.createElement('table');
                        table.style.width = '100%';

                        // Header
                        const thead = document.createElement('thead');
                        const headerRow = document.createElement('tr');
                        data.rows[0].forEach((_, idx) => {
                            const th = document.createElement('th');
                            th.textContent = `Column ${idx + 1}`;
                            headerRow.appendChild(th);
                        });
                        thead.appendChild(headerRow);
                        table.appendChild(thead);

                        // Body
                        const tbody = document.createElement('tbody');
                        data.rows.forEach(row => {
                            const tr = document.createElement('tr');
                            row.forEach(cell => {
                                const td = document.createElement('td');
                                td.textContent = cell;
                                tr.appendChild(td);
                            });
                            tbody.appendChild(tr);
                        });
                        table.appendChild(tbody);

                        resultDiv.innerHTML = '';
                        resultDiv.appendChild(table);
                    } else {
                        resultDiv.innerHTML = '<div>No results returned</div>';
                    }
                }
                resultDiv.style.display = 'block';
            })
            .catch(e => {
                resultDiv.innerHTML = `<div class="error">Network error: ${e.message}</div>`;
                resultDiv.style.display = 'block';
            });
        }

        // Initialize
        connectEventStream();
        updateMetrics();
        updateTopUsers();
        updateTimelineChart();
        updateEventTypesChart();

        // Periodic updates
        setInterval(updateMetrics, 2000);
        setInterval(updateTopUsers, 3000);
        setInterval(updateTimelineChart, 5000);
        setInterval(updateEventTypesChart, 5000);
    </script>
</body>
</html>
